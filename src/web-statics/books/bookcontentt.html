<!DOCTYPE html>
<html class="greee">
<head>
<meta charset="utf-8">
<title>嗖</title>  
<link href="../bootstrap/5.1.1/bootstrap.min.css" rel="stylesheet">
<script src="../bootstrap/5.1.1/bootstrap.bundle.min.js"></script> 
<script src="../js/vue.global.js"></script>
<script src="../js/axios.min.js"></script> 
<link href="css_book.css" rel="stylesheet"> 

<script src="js_book.js"></script>
</head>
<body>
<div id = "app"   @mousedown="clearSel" > 
	   
<div class="bk_content_frame" @mousedown="clearSel"  >
	 
<div class="bk_content_title"  >  
	 
	<div class="bk_content_title  " > 	 
		  
		<div   style="width: 23% ;padding-left: 20px;">
			 <b>{{book.chiefAlbum}}.{{book.name}} </b> 
		</div >	
		<div   style="width: 45% ">
			 
				 
		</div >	 
		<div  style="width: 23% " > 
				 <a id="showy" style="cursor: pointer;"   @click="showTrans(0)" >  原  </a>
					   &emsp;<a  id="showd" style="cursor: pointer;"  @click="showTrans(1)" >  段  </a>
					   &emsp;<a  id="showt" style="cursor: pointer;"  @click="showTrans(2)" >  译  </a>
		</div >	   
	</div >	       
</div >         
 
<div  class="bk_content_box" style="margin-top:37px ;">
	<div class="bk_content_boxinner"> 	  
	    <div  v-for="para in paras" v-bind:id="para.gid"  
	    class="para_border" @mouseup="handleMouseUp(para.gid)" 
	    @mousedown="handleMouseDown(para.gid)" >  
			 
	       <div class=" bk_onecontent"  
	       style="margin-right:0.1rem;margin-left:0.3rem"  >
	       
			  <span    @mouseup="showMsg">&emsp;&emsp;{{para.content}}</span> 
		  </div> 
	       <div class=" bk_transcation"   style="margin-right:0.1rem;margin-left:0.3rem"  > 
			  <span    @mouseup="showMsg">&emsp;&emsp;{{para.transcation}}</span>  
		  </div> 
	       
	  	</div>
  	 </div> 
 
</div>               
 
</div>


<div  class="target_tool"   >
 	  
		
		<div class="input-group tx_mb_2">
			 <select class="form-select" v-model="target"  id="target" @change="tarChangeed($event)">
			<option v-for="tar in targets" :value="tar.id" :data-text="tar.details">
			  {{ tar.name }}  
			</option>
			</select> 
			<button type="button" class="btn btn-primary" @click="toSaveRelation">
				<svg  width="25" height="25" fill="currentColor" class="bi bi-link" viewBox="0 0 16 16">
				  <path fill-rule="evenodd" d="M1 8a7 7 0 1 1 2.898 5.673c-.167-.121-.216-.406-.002-.62l1.8-1.8a3.5 3.5 0 0 0 4.572-.328l1.414-1.415a.5.5 0 0 0 0-.707l-.707-.707 1.559-1.563a.5.5 0 1 0-.708-.706l-1.559 1.562-1.414-1.414 1.56-1.562a.5.5 0 1 0-.707-.706l-1.56 1.56-.707-.706a.5.5 0 0 0-.707 0L5.318 5.975a3.5 3.5 0 0 0-.328 4.571l-1.8 1.8c-.58.58-.62 1.6.121 2.137A8 8 0 1 0 0 8a.5.5 0 0 0 1 0Z"/>
				  </svg>
			</button>
			<input type="hidden" v-model="paraId"   class="form-control" >
		
		</div> 
		  
</div>
              

<!-- 模态框 -->
<div class="modal" id="myModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <!-- 模态框头部 -->
      <div class="tx_modal_header"> 
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        <h4 class="modal-title">新增关联对象</h4>
      </div>

      <!-- 模态框内容 -->
      <div class="modal-body">
        <div class="container mt-3">
 
			<form  class="needs-validation">
				 
				<input type="hidden" v-model="tarid"   class="form-control" >
				  
				<div class="input-group tx_mb_2">
					<span class="input-group-text">名称</span>
					<input type="text" v-model="tarname4Add"  class="form-control" placeholder="名称"  >
				</div> 
				<div class="input-group tx_mb_2">
					<span class="input-group-text">朝代</span>
					 <select class="form-select" v-model="dynasty"  id="dynasty" >
						<option v-for="dyn  in dynastys" :value="dyn.id" >
						  {{ dyn.name }}  
						</option>
					</select> 
				</div> 
				<div class="input-group tx_mb_2">
					<span class="input-group-text">描述</span>
					<textarea  cols="8" rows="10"  v-model="tardetails"  class="form-control" placeholder="简介描述"></textarea>
				</div> 
				 
			  
				<!-- 模态框底部 -->
			  	<div class="modal-footer">
					<button type="button" class="btn btn-danger" data-bs-dismiss="modal">关闭</button>
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" @click="toAddTarget" >保存</button>
			  </div>				
			</form>
		</div>
      </div>
    </div>
  </div>
</div>   
 

<div class="fixed-btn-top"> 
 
		<a  class="fixed-btn-a" style="cursor: pointer;" data-bs-toggle="modal" data-bs-target="#myModal"   > 
		   <svg   width="25" height="25" fill="currentColor"  viewBox="0 0 16 16">
			 <path fill-rule="evenodd" d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.5-5a.5.5 0 0 0-1 0v1h-1a.5.5 0 0 0 0 1h1v1a.5.5 0 0 0 1 0v-1h1a.5.5 0 0 0 0-1h-1v-1Z"/>
			 <path fill-rule="evenodd" d="M12.096 6.223A4.92 4.92 0 0 0 13 5.698V7c0 .289-.213.654-.753 1.007a4.493 4.493 0 0 1 1.753.25V4c0-1.007-.875-1.755-1.904-2.223C11.022 1.289 9.573 1 8 1s-3.022.289-4.096.777C2.875 2.245 2 2.993 2 4v9c0 1.007.875 1.755 1.904 2.223C4.978 15.71 6.427 16 8 16c.536 0 1.058-.034 1.555-.097a4.525 4.525 0 0 1-.813-.927C8.5 14.992 8.252 15 8 15c-1.464 0-2.766-.27-3.682-.687C3.356 13.875 3 13.373 3 13v-1.302c.271.202.58.378.904.525C4.978 12.71 6.427 13 8 13h.027a4.552 4.552 0 0 1 0-1H8c-1.464 0-2.766-.27-3.682-.687C3.356 10.875 3 10.373 3 10V8.698c.271.202.58.378.904.525C4.978 9.71 6.427 10 8 10c.262 0 .52-.008.774-.024a4.525 4.525 0 0 1 1.102-1.132C9.298 8.944 8.666 9 8 9c-1.464 0-2.766-.27-3.682-.687C3.356 7.875 3 7.373 3 7V5.698c.271.202.58.378.904.525C4.978 6.711 6.427 7 8 7s3.022-.289 4.096-.777ZM3 4c0-.374.356-.875 1.318-1.313C5.234 2.271 6.536 2 8 2s2.766.27 3.682.687C12.644 3.125 13 3.627 13 4c0 .374-.356.875-1.318 1.313C10.766 5.729 9.464 6 8 6s-2.766-.27-3.682-.687C3.356 4.875 3 4.373 3 4Z"/>
			  </svg>
		</a>
</div> 

<div class="fixed-btn"> 
 
		<a  class="fixed-btn-a" href="index.html"> 
		    <svg   width="25" height="25" fill="currentColor"   viewBox="0 0 16 16">
		  <path d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L8 2.207l6.646 6.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5Z"/>
		  <path d="m8 3.293 6 6V13.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13.5V9.293l6-6Z"/>
		</svg>
		</a>
		
		
			<a  class="fixed-btn-a"   v-bind:href="'album.html?albid='+ albid"  > 
		    <svg  width="25" height="25" fill="currentColor" viewBox="0 0 16 16">
		  <path fill-rule="evenodd" d="M2 12.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
		</svg>
		</a>
		    
		
		
		
		<a  class="fixed-btn-a"  href="pers.html"> 
		<svg   width="25" height="25" fill="currentColor" class="bi bi-person-workspace" viewBox="0 0 16 16">
		  <path d="M4 16s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H4Zm4-5.95a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
		  <path d="M2 1a2 2 0 0 0-2 2v9.5A1.5 1.5 0 0 0 1.5 14h.653a5.373 5.373 0 0 1 1.066-2H1V3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v9h-2.219c.554.654.89 1.373 1.066 2h.653a1.5 1.5 0 0 0 1.5-1.5V3a2 2 0 0 0-2-2H2Z"/>
		</svg>
		</a>
		
		
				<a  class="fixed-btn-a"  href="search.html"> 
		   <svg  width="30" height="30" fill="currentColor"   viewBox="0 0 16 16">
		  <path d="M3 2.5A1.5 1.5 0 0 1 4.5 1h1A1.5 1.5 0 0 1 7 2.5V5h2V2.5A1.5 1.5 0 0 
		  1 10.5 1h1A1.5 1.5 0 0 1 13 2.5v2.382a.5.5 0 0 0 .276.447l.895.447A1.5 1.5 0 0 1 15 
				  7.118V14.5a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 14.5v-3a.5.5 0 0 1 .146-.354l.854-.853V9.5a.5.5 
				  0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v.793l.854.853A.5.5 0 0 1 7 11.5v3A1.5 1.5 0 0 1 5.5 16h-3A1.5 1.5 0 0 
				  1 1 14.5V7.118a1.5 1.5 0 0 1 .83-1.342l.894-.447A.5.5 0 0 0 3 4.882V2.5zM4.5 2a.5.5 0 0 0-.5.5V3h2v-.5a.5.5 0
				   0 0-.5-.5h-1zM6 4H4v.882a1.5 1.5 0 0 1-.83 1.342l-.894.447A.5.5 0 0 0 2 7.118V13h4v-1.293l-.854-.853A.5.5 0 0 1 
				   5 10.5v-1A1.5 1.5 0 0 1 6.5 8h3A1.5 1.5 0 0 1 11 9.5v1a.5.5 0 0 1-.146.354l-.854.853V13h4V7.118a.5.5 0 0 0-.276-.447l-.895-.
				   447A1.5 1.5 0 0 1 12 4.882V4h-2v1.5a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5V4zm4-1h2v-.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5V3zm4 
				  11h-4v.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5V14zm-8 0H2v.5a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5V14z"/>
				</svg>
				</a>
		
		</div>    
    
</div> 

 
   
<script>


  
const app = {
	data() {
		return { 
			 paras:[] ,
			 book:{}, 
			 targets:[],
			 paraId:0,
			 paragra:"",
			 albid:0,
			 linkTars:[],
			 target:'',
			 targetName:'',
			 tarname4Add:"",
			 dynastys:[],
			 targetdetail:""
		}
	},
	mounted () {
		const bookid = getUrlParam('bookid')
		 
		const params = {bookid:bookid}
				  
		axios.get('/selectcontents',{params:params})
		  .then(response => {
			  this.paras = response.data.reObject["paras"]
			  this.book = response.data.reObject["book"]
			  this.albid = this.book.albumId
			  document.title = this.book.chiefAlbum + "-" + this.book.name
			})
		  .catch(function (error) {  
			 showErrTips(error) 
		});
		
		
		axios.get('/selectDynasty' ,{params:params} )
		  .then(response => {
			  this.dynastys = response.data.reObject  
			})
		  .catch(function (error) {  
			 showErrTips("朝代信息：" + error) 
		});
		
		 
	} ,
	methods: {
		handleMouseDown(pid) {
			this.targetdetail = "" 
			this.linkTars  = getTargets(pid)
			 
			let byClassDivs = document.getElementsByClassName('para_sel_border')
			
			for (var i=0;i<byClassDivs.length;i++)
			{ 
			    byClassDivs[i].className = "para_border"
			}
			
			let  selDiv =  document.getElementById(pid)
			
			selDiv.className = "para_sel_border" 
			this.paraId = pid 
			
		},
		
	    handleMouseUp(pid) {
			this.targetdetail = ""
			this.linkTars  = getTargets(pid)
			
			let byClassDivs = document.getElementsByClassName('para_sel_border')
			
			for (var i=0;i<byClassDivs.length;i++)
			{ 
			    byClassDivs[i].className = "para_border"
			}
			
			let  selDiv =  document.getElementById(pid)
			
			selDiv.className = "para_sel_border"	 

	    	this.paraId = pid
	    	  
	    },
	    showMsg(event)
	    {
			 
			let targetName = window.getSelection().toString()
	    	this.targetName = targetName
	    	this.tarname4Add = this.targetName
	    	 
	    	 
	    	this.queryTargets( )
	    	
		 	var oMsg = document.getElementById("msg");
	    	oMsg.className = "tx_msg_show"	
	    	
	    	oMsg.style['left'] = event.screenX + 5 + 'px';
            oMsg.style['top'] = event.screenY + 5 + 'px';
		},
	    queryTargets(){
			targetName = this.targetName 
			if(targetName==null||targetName=='')
	    	{
				this.targets = []
				return
			}
			 
			const params = {targetName:targetName}	  
			axios.get('/selectTargets',{params:params})
		  	.then(response => {
			  	this.targets = response.data.reObject   
			  	this.target = this.targets[0].id
			  	
			  	this.targetdetail = this.targets[0].details
			  	
			  	if(this.targets.length>0)
				{
					var oMsg = document.getElementById("msg");
	    			oMsg.className = "tx_msg_show"	
				} 
				
				 
			})
		  	.catch(function (error) {  
			 	 
			}); 
			
			
			
			
		},
	    toSaveRelation(){
			paraId = this.paraId 
			if (paraId<=0)
			{ 
				return;
			}
			 
			const params = {targetId:this.target,paragId:this.paraId}
			 
			axios({
				method:'post',
				url:'/addlink',
				data: params				
			}).then(function(response) {
				showOKTips( "添加成功！")
			}).catch(function (error) { // 请求失败处理
				showErrTips( "添加失败！")
			});  
			
			this.linkTars  = getTargets(paraId)
		},
		clearSel(){
			 let byClassDivs = document.getElementsByClassName('para_sel_border')
			
			for (var i=0;i<byClassDivs.length;i++)
			{ 
			    byClassDivs[i].className = "para_border"
			}
			 
			this.paraId = 0
		} ,
		toAddTarget()
		{
			const params = {  
				name : this.tarname4Add,
				dynasty : this.dynasty,
				details  :this.tardetails 
			}
			 
			
             axios
			  .post('/addtarget', params)
			  .then(
			  function (response) {
				  showOKTips(params.name + "：新增成功！")
			  }  
			  )
			  .catch(function (error) { // 请求失败处理
				  showErrTips(params.name + "：新增失败！")
			});    
		},
		tarChangeed()
		{
			let  selTar =  document.getElementById("target") 
			var index = selTar.selectedIndex ;
			 
			this.targetdetail = selTar.options[index].getAttribute("data-text")
			
		},handleMouseDown(pid) {
			
			this.targetdetail = "" 
			//this.linkTars  = getTargets(pid)
			 
			let byClassDivs = document.getElementsByClassName('para_sel_border')
			
			for (var i=0;i<byClassDivs.length;i++)
			{ 
			    byClassDivs[i].className = "para_border"
			}
			
			let  selDiv =  document.getElementById(pid)
			
			selDiv.className = "para_sel_border" 
			this.paraId = pid  
			
		},
		
	    handleMouseUp(pid) {
			this.targetdetail = ""
			//this.linkTars  = getTargets(pid)
			
			let byClassDivs = document.getElementsByClassName('para_sel_border')
			
			for (var i=0;i<byClassDivs.length;i++)
			{ 
			    byClassDivs[i].className = "para_border"
			}
			
			let  selDiv =  document.getElementById(pid)
			
			selDiv.className = "para_sel_border"	 
 
	    	this.paraId = pid
	    	 
	    	this.addReadRecord(pid)  
	    	 
	    },
		
	}
	 
}
 
vm = Vue.createApp(app).mount('#app')
 
</script>
 

</body>
</html>