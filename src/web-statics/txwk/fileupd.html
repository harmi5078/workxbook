<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>文件数据上传管理</title>  
<link href="../bootstrap/5.1.1/bootstrap.min.css" rel="stylesheet">  
<script src="../bootstrap/5.1.1/bootstrap.bundle.min.js"></script>  
<script src="../js/vue.global.js"></script>
<script src="../js/axios.min.js"></script>
<script src="js_txnav.js"></script>
<script src="js_txcommon.js"></script> 
<link href="css_txworks.css" rel="stylesheet"> 

<style>
	
#img_input2 {
  display: none;
}
#img_label2 {
  background-color: rgb(0, 64, 64);
  border-radius: 5px;
  display: inline-block;
  padding: 10px;
  cursor: pointer;
}
</style>
</head>
<body>

<div id="startmenu" style="z-index:88;"></div> 
<div id = "app" onmousedown="closeNav()" style="z-index: 8;"> 	
 
<div  class="tx_oneframe" onmousedown="closeNav()"> 
	   
        <div class="container mt-3"> 
				 
				 	<div id="drop_zone" class="tx_dropfiles" >
						 <div class="tx_dropfiles_innerdesc2"> 
							   批量,最多10个  
						</div> 
						  
						<div  class=" tx_dropfiles_innerdesc">  
							    PDF格式的报关单、发票，拖到这里  
						</div> 
						
						 <div class="tx_dropfiles_btn"> 
							   <input id="img_input2" type="file" multiple="multiple" accept="pdf/*"  @change="uploadFile" />
									<label for="img_input2" id="img_label2">选择PDF</label>
						</div> 
					 </div>
					
					<output id="list"></output>
					 
					<hr />
				 
				<iframe src="" frameborder="0" name="frameName" style="height: 1px;display: none;"></iframe>
			   
		</div>
		
		
		<div class="tx_onerow tx_tab_header" >
		    <div style="width: 5%;">序号</div >
			<div style="width: 20%;">名称</div >	 
			<div style="width: 8%;">内容</div >	 	
			<div style="width: 15%;">上传时间</div >	
			<div style="width: 10%;">状态</div >	  
			<div style="width: 42%;">备注</div >	 
		</div>
		
		<div class="tx_onerow tx_tab_row " v-for="(item,index) in items" v-bind:id="'tid'+item.tid"> 
			<div style="width: 5%;">   {{(fstartpage -1)*20  + index +1 }} </a></div >
			<div style="width: 20%;">  {{ item.name }} </div >	
			<div style="width: 8%;">    <span v-if="item.type==1"> 发票</span>   <span v-else-if="item.type==2"> 报关单</span> <span v-else> 未分类</span>  </div >		 
			<div style="width: 15%;">{{ item.createTime }}</div >  
			<div style="width: 10%;"> <span v-if="item.status==1"> 数据处理中</span>   <span v-else-if="item.status==2"> 数据处理完成</span>   <span v-else-if="item.status==4">已归档</span> <span v-else> 等待处理</span> </div >  
			<div style="width: 37%;">{{ item.remark }}  </div >	
			<div style="width: 5%;" v-if="item.status<=1">导入</div > 
		</div>   
</div>

</div>
 
<script>
 	
const app = {

	data() {
		return {
		  items : [] ,	 
		  startmenuHtml : getStartMenuHtml_fb() ,
		  fstartpage:1
		   
		}
	},
	mounted () { 
		
		this.reloadData()
		window.updateTables = this.reloadData;
	},
	methods: { 
		  
		reloadData(event) { 
			
			const params = {  
				  type : 1
			  }
			
			 axios
			  .get('/getfiles',{params:params} )
			  .then(response => (this.items = response.data.reObject))
			  .catch(function (error) { // 请求失败处理
				showErrTips("数据加载失败：" + error) 
			});
		}  ,
		loadData(item)
		{ 
			 
			const params = {  
				  fid : item.fid,
				  name:item.name,
				  fileName:item.fileName,
				  filePath:item.filePath,
				  status:item.status
			  }
			  
			  axios
			  .post('/loadbefile', params )
			  .then(
			  function (response) {
				 showOKTips(params.shortDesc + "添加成功！")
			  } 
			  )
			  .catch(function (error) { // 请求失败处理
				  showErrTips(params.shortDesc + "添加失败！")
			});    
		},
		uploadFile(event) {   
	       
	      	let files = event.target.files;  
	         
			  // 处理多文件
			var output = [];
			
			for (var i = 0, f; f = files[i]; i++) { 
				var filename = f.name
				fileExt = filename.substring(filename.lastIndexOf('.') + 1);
				if(fileExt=="pdf" || fileExt=="PDF")
				{ 
					var formData = new FormData();
					formData.append('file', f);
					axios.post('/upload', formData, {})
					output.push('<li><strong>',  f.name , '</strong> 已上传</li>'); 
				}else{
					output.push('<li><strong>',  f.name , '</strong> 文件格式不正确</li>'); 
				}
				
			}
				  // 显示文件信息
			document.getElementById('list').innerHTML = output.join('');
	
	       	this.reloadData()
	    }
 
		
	}  
}
 
vm = Vue.createApp(app).mount('#app')
 
</script>
<script type="text/javascript">
function clearFile(){
   document.getElementById("billentry").value = ""
}
   
function handleFileSelect(evt) {
	evt.stopPropagation();
	evt.preventDefault();
	
	var files = evt.dataTransfer.files; // 文件对象
	
	  // 处理多文件
	var output = [];
	
	for (var i = 0, f; f = files[i]; i++) { 
		var filename = f.name
		fileExt = filename.substring(filename.lastIndexOf('.') + 1);
		if(fileExt=="pdf" || fileExt=="PDF")
		{ 
			var formData = new FormData();
			formData.append('file', f);
			axios.post('/upload', formData, {})
			output.push('<li><strong>',  f.name , '</strong> 已上传</li>'); 
		}else{
			output.push('<li><strong>',  f.name , '</strong> 文件格式不正确</li>'); 
		}
		
	}
		  // 显示文件信息
	document.getElementById('list').innerHTML = output.join('');
	
	 
	updateTables()
	 
}

function handleDragOver(evt) {
	evt.stopPropagation();
	evt.preventDefault();
	evt.dataTransfer.dropEffect = 'copy';
}

// Setup the dnd listeners.
var dropZone = document.getElementById('drop_zone');
dropZone.addEventListener('dragover', handleDragOver, false);
dropZone.addEventListener('drop', handleFileSelect, false);

</script> 

</body>
</html>