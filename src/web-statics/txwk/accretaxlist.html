<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>退税流水管理</title>  
<link href="../bootstrap/5.1.1/bootstrap.min.css" rel="stylesheet">  
<script src="../bootstrap/5.1.1/bootstrap.bundle.min.js"></script>  
<script src="../js/vue.global.js"></script>
<script src="../js/axios.min.js"></script>
<script src="js_txnav.js"></script>
<script src="js_txcommon.js"></script> 
<link href="css_txworks.css" rel="stylesheet"> 
</head>
<body >
<div id="startmenu" style="z-index:88;"></div> 
<div id = "app" onmousedown="closeNav()" style="z-index: 8;"> 	 
<div class="tx_topLev2"  > </div>  
<div   id="maindiv"  class="tx_oneframe"  onmousedown="closeNav()" style="font-family: 宋体; background-color: aliceblue;"> 
<div class="tx_onerow" style="position: fixed;width: 86.5%;background-color: aliceblue;">  
	<div   class="tx_acccheckheader" style="margin-top:20px ;" >	 
			 泰湘贸易有限公司退税明细表
	</div>
	<div class="tx_onerow  " style="width: 100% ;margin-bottom: 3px;"> 	 
		  
		<div   style="width: 23% ">
			 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 起始日期：</div> 
									<div class="tx_accvalue"> 
										<input type="date" @change="reloadData()" v-model="startTime"  class="tx_titleDateLabel  " placeholder="支付时间" 
					 min="2020-01-01" max="2025-12-31">  </div>
				 </div> 
		</div >	 
		<div  style="width: 23% "> 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 截止日期：</div> 
									<div class="tx_accvalue"><input type="date" @change="reloadData()" v-model="endTime"  class="tx_titleDateLabel" placeholder="支付时间" 
					 min="2020-01-01" max="2025-12-31">  </div>
				 </div> 
		</div >	   
	</div >	    
	
	<div class="tx_onerow  " style="width: 100% ;margin-bottom: 3px;"> 	  
		<div   style="width: 23% "> 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 代理费用：</div> 
									<div class="tx_accvalue">  {{ totalFeeAmt}} </div>
				 </div> 
		</div >	 
		<div  style="width: 23% "> 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 税金合计：</div> 
									<div class="tx_accvalue"> {{ totalInvTaxAmt}} </div>
				 </div> 
		</div >	  
		<div  style="width: 23% "> 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 退税总计：</div> 
									<div class="tx_accvalue"> {{ totalRetaxAmt}} </div>
				 </div> 
		</div >	 
		<div  style="width: 23% "> 
				<div class="tx_acheckgroup"> 
									<div class="tx_accname"> 收入总计：</div> 
									<div class="tx_accvalue"> {{totalRetaxAmt -totalInvTaxAmt- totalFeeAmt}} </div>
				 </div> 
		</div > 
	</div >	   
	
	<div class="tx_onerow" style="font-weight: bold;width: 100%;border-top: var(--cell-boder );" >
			<div style="width: 5%;" class=" " align="center"  >序号</div >
		    <div style="width: 8%;padding-left:8px;" class="tx_cellboder_left " @click="orderDataByDate()" >日期 
				<i id="dateOrderType" class=" "></i> </div >
			<div style="width: 17%;padding-left:8px;" class="tx_cellboder_left "><input type="text"  @change="reloadData()" v-model="fremark" class="tx_acekTitleLabel" placeholder="摘要"  ></div >	 
			<div style="width: 10%;padding-left:8px;" class="tx_cellboder_left">支出金额</div >	 	
			<div style="width: 10%;padding-left:8px;" class="tx_cellboder_left">收入金额</div >	 
			<div style="width: 8%;padding-left:8px;" class="tx_cellboder_left">类型</div >	 
			<div style="width: 6%;padding-left:8px;" class="tx_cellboder_left">泰湘账户</div >	 
			<div style="width: 6%;padding-left:8px;" class="tx_cellboder_left">业务项目</div >	 
			<div style="width: 28%;padding-left:8px;" class="tx_cellboder_left"><input type="text"  @change="reloadData()" v-model="fpayCompany" class="tx_acekTitleLabel" placeholder="对方公司"  > </div > 
	</div> 
	 
</div >
<div style="margin-top: 142px;border-top: var(--cell-boder );">  
		<div  class="tx_onerow tx_tab_row " v-for="(item,index) in tradeList" @dblclick="toedit(item)" v-bind:id="'tid'+item.tid" v-bind:title="item.payAccName +'|'+ item.payAccInfo" style="width: 100%;border-top: var(--cell-boder );"> 
			<div style="width: 5%;padding-left:8px;cursor: pointer;" class="  " align="center"> <a @click="toEdit(item)" data-bs-toggle="modal"  data-bs-target="#myModal" > {{(fstartpage -1)*20  + index +1 }} </a></div >
			<div style="width: 8%;padding-left:8px;" class="tx_cellboder_left "  v-bind:id="'tdate'+item.tid">{{ item.payTime }} </div >
			<div style="width: 17%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'tremark'+item.tid"><a @click="toEdit(item)" data-bs-toggle="modal"  data-bs-target="#myModal" > {{ item.remark }} </a></div >	 
			<div style="width: 10%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'tpayamt'+item.tid"> <span v-if="item.ioFlag==1"> {{ item.payAmt }} </span>    </div >	 
			<div style="width: 10%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'trecamt'+item.tid"> <span v-if="item.ioFlag==2"> {{ item.payAmt }}</span> </div >  
			<div style="width: 8%;padding-left:8px;" class="tx_cellboder_left "  v-bind:id="'paytype'+item.tid">
				<span v-if="item.type==1"> 退税到账</span>   
				<span v-else-if="item.type==2"> 开票税金</span>   
				<span v-else-if="item.type==3">代理费用</span> 
				<span v-else>其他</span>     
			</div >	
			<div style="width: 6%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'oacc'+item.tid">  {{ item.owerAlias }}  </div >	
			<div style="width: 6%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'paycom'+item.tid"> {{item.businessName}}   </div >	
		  	<div style="width: 28%;padding-left:8px;" class="tx_cellboder_left " v-bind:id="'paycom'+item.tid">  {{ item.payAccName }}  </div >	
		  
		</div>  
</div>
<div class="tx_onerow "  style="border-top: var(--cell-boder );border-left: var(--cell-boder );border-right: var(--cell-boder );" >
		    <div style="width: 50%;" > 共{{pageable.rowCount}}笔 <span v-if="pageable.rowCount>100"> 建议调整搜索条件缩小范围 </span></div >
			 
</div> 				
  
<div class="tx_leftbtn" @click="toAddNew"  data-bs-toggle="modal" data-bs-target="#myModal">
	<a >
 <svg xmlns="http://www.w3.org/2000/svg" class="svgggg" width="36" height="26" fill="currentColor"  viewBox="0 0 16 16">
  <path d="M8 6.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V9.5H6a.5.5 0 0 1 0-1h1.5V7a.5.5 0 0 1 .5-.5z"/>
  <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z"/>
</svg>
</a>
</div>
 
   
<!-- 模态框 -->
<div class="modal" id="myModal">
  <div class="modal-dialog tx_modal_dlg">
    <div class="modal-content">

      <!-- 模态框头部 -->
      <div class="tx_modal_header">
        <h4 class="modal-title">{{modelTitle}}</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- 模态框内容 -->
      <div class="tx_modal_body">
        <div class="container mt-3">
 
			<form  class="needs-validation">
				<input type="hidden" v-model="isedit"   class="form-control" >
				<input type="hidden" v-model="tid"   class="form-control" >
				
				 <div class="input-group tx_mb_2">
					<span class="tx_input_text">发生金额</span>
					<input type="text" v-model="payAmt"  class="form-control tx_input_font" placeholder="金额">
				</div> 
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">业务备注</span>
					<input type="text" v-model="remark"  class="form-control tx_input_font" placeholder="备注">
				</div>	
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">发生时间</span>
					<input type="date"  v-model="payTime"  class="form-control tx_input_font" placeholder="支付时间" 
					 min="2020-01-01" max="2025-12-31">
				</div> 
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">金额类型</span>
					<select class="form-select tx_input_font" v-model="amtType" @change="selectType"> 
						<option value="1">退税入账</option>
						<option value="2">开票税金</option>
						<option value="3">代理费用</option>
						<option value="4">其他类型</option>
					</select> 
				</div> 
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">进出标记</span>
					<select class="form-select tx_input_font" v-model="ioFlag"> 
						<option value="1" >出账</option>
						<option value="2">入账</option>
					</select> 
				</div> 
				<div class="input-group "  >
					<span class="tx_input_text">业务项目</span>
					<select id="busList"  @change="selectBusiness" class="form-select tx_input_font" v-model="business" >
						<option v-for="bus  in businessList" :value="bus.businessId" :data="bus.businessId">
						  {{ bus.name }}|| ({{ bus.companyName }} & {{ bus.partnerName }})
						</option>
					</select>
				</div>  
			 
				 
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">泰湘账号</span>
					<select class="form-select tx_input_font" v-model="owerAccount"  id="owerAccount" >
						<option v-for="acc in owerAccounts" :value="acc.accId">
						  {{ acc.accName }} || {{ acc.accNo }} 
						</option>
					</select>
				</div> 
			  
				<div class="input-group tx_mb_2">
					<span class="tx_input_text">业务账户</span>
					<select class="form-select tx_input_font" v-model="payAccount">
						<option v-for="acc in accounts" :value="acc.accId"  >
						  {{ acc.accDesc }} 
						</option>
					</select>
				</div> 
				  
				<!-- 模态框底部 -->
			  	<div class="modal-footer">
				<button type="button" class="tx_btn_danger" data-bs-dismiss="modal">关闭</button>
				<button type="button" @click="toSaveTrade" data-bs-dismiss="modal" class="tx_btn_primary" >保存</button>
			  </div>				
			</form>
		</div>
      </div>
 

    </div>
  </div>
</div>
 
 
</div>
 
    
</div>       
</body>
<script>
	



const app = {
	data() {
		return {
		  tradeList : [] ,	 
		  startmenuHtml : getStartMenuHtml_fb() , 
		  modelTitle : '新增资金流水',  
		  ioFlag:2, 
		  amtType:1, 
		  owerAccount: '',  
		  payAccount: '', 
		  business : '', 
		  payAmt: '',
		  payTime: '',
		  payType: 1, 
		  remark:'',
		  fpayCompany:'',
		  fioFlag:0,
		  fowerAccount:0,
		  fstartpage:1,
		  startTime:'',
		  endTime:'',
		  fremark:'',
		  pageable:[], 
		  pageCount:0,
		  isedit: false	,
		  businessList :[], 
		  owerAccounts : [],
		  payAccounts : [] ,
		  feeAccounts:[],
		  taxAccounts:[],
		  accounts:[], 
		  totalFeeAmt:0.0,
		  totalInvTaxAmt:0.0,  
		  totalRetaxAmt:0.0,  
		  totalDifAmt:0.0,
		    
		   
		  orderDate:0 
		}
	},
	mounted () {
		 
		this.payTime = getDate() 
		this.endTime = getDate()   
		this.startTime = "2021-11-09"  
		 
		axios.get('/gettaxopaccs')
		  .then(response => {
			  this.owerAccounts = response.data.reObject["owers"]  
			  this.owerAccount = this.owerAccounts[0].accId	  
			  
			  this.payAccounts = response.data.reObject["pays"]  
			  this.payAccount = this.payAccounts[0].accId
			  
			  this.feeAccounts = response.data.reObject["fees"]  
		  	  this.taxAccounts = response.data.reObject["taxs"]  
		  	  
		  	  this.accounts = this.taxAccounts
		  	  this.payAccount = this.accounts[0].accId 
			  
		}).catch(function (error) { // 请求失败处理
			 
		});  
		
		const params = {    
			retax:1
	 	}	 
		 	
		axios.get('/getbusiness',{params:params})
		  .then(response => {
			  this.businessList = response.data.reObject   
			  this.business =this.businessList[0].businessId 
		}).catch(function (error) { // 请求失败处理
			 
		});   
		 
		this.loadData() 
		 
              
	},
	methods: { 
		selectType()
		{ 
			this.ioFlag = (this.amtType==1)?2:1  
			
			if(this.amtType==2)
			{
				this.accounts = this.payAccounts
		  	  	
			}else if(this.amtType==1)
			{
				this.accounts = this.taxAccounts
		  	  	 
			}else if(this.amtType==3)
			{
				this.accounts = this.feeAccounts 
			}else{
				this.accounts = this.payAccounts
			}
			
			this.payAccount = this.accounts[0].accId 
			  
		},
		selectBusiness()
		{
			if(this.amtType==1||this.amtType==3)
			{
				return
			}
			 
			const params = {    
				businessId:this.business
		 	} 
		 	
			axios.get('/getbusaccs',{params:params})
		  	.then(response => { 
				  this.accounts = response.data.reObject["recs"]  
				  this.payAccount = this.accounts[0].accId  
				  
			}).catch(function (error) { // 请求失败处理  
			});  
		},
		orderDataByDate()
		{
			var div = document.getElementById("dateOrderType"); 
			if(this.orderDate==0 || this.orderDate==1)
			{
				this.orderDate=2
				div.className = "tx_icon_orderup"; 
			}
			else if(this.orderDate==2){
				this.orderDate=1
				div.className = "tx_icon_orderdown"; 
			}
			
			this.loadData(); 
		},
		reloadData()
		{ 
			
		 	this.loadData( )  
	                    
		}  ,
		loadData() { 
			
			orderDateField = ""
			if(this.orderDate==2)
			{
				orderDateField = " acc.paytime "
			}else{
				orderDateField = " acc.paytime desc "
			}
			 
			
			const params = {   
				remark:this.fremark,
				startTime:this.startTime,
				endTime:this.endTime,
				payCompany:this.fpayCompany,
				orderField:orderDateField,
				pageSize:100
		 	}	 
		 	
			  axios
			  .get('/getaccretaxlist',{params:params})
			  .then(response => {
				  
				  this.tradeList = response.data.reObject
				  this.pageable = response.data.pageable  
				  this.pageCount = this.pageable.pageCount
				  
				  this.totalFeeAmt = response.data.reportData['T3']
			 	  this.totalInvTaxAmt = response.data.reportData['T2']
			 	  this.totalRetaxAmt = response.data.reportData['T1']
			   
			  })
			  .catch(function (error) { // 请求失败处理
				 
			});
		} ,
		
		toSaveTrade(event){
			
			const params = { 
				businessId : this.business, 
				owerAccount: this.owerAccount,
				payAccount: this.payAccount,
				payAmt: this.payAmt,
				payTime: this.payTime,
				type:this.amtType, 
				remark : this.remark,
				ioFlag : this.ioFlag,
				tid : this.tid
			}	
			
			if(!this.isedit)
			{
				this.addtrade(event,params);
			}
			else
			{ 
				this.savetrade(event,params);
			}
			 
			this.reloadData()
			
			var  tidd = "tid" + this.tid
			tipDiv(tidd)
		} ,
		
		savetrade(event,params) {
			
             axios
			  .post('/saveretax',params)
			  .then(
			  function (response) {
				showOKTips("修改成功！") 
			  }  
			  )
			  .catch(function (error) { // 请求失败处理
				showErrTips("修改失败！")   
			});    
        } ,
        addtrade(event,params) {
			 
            axios
			  .post('/addretax', params )
			  .then(
			  function (response) {
				 showOKTips("新增成功！") 
				 
			}).catch(function (error) { // 请求失败处理
				showErrTips( "新增失败！")
			});  
			
			this.loadData()  
			
        } ,
        toEdit(item)
        { 
			this.accounts = this.payAccounts
			
			this.isedit = true
			this.modelTitle ="编辑" 
			this.business = item.businessId 
			this.payAccount = item.payAccount
			this.owerAccount = item.owerAccount
			this.payAmt = item.payAmt
			this.payTime = item.payTime
			this.amtType = item.type  
			this.remark = item.remark
			this.ioFlag = item.ioFlag
			this.tid = item.tid
			 
		},
		toAddNew(){ 
			this.payTime = getDate()
			this.modelTitle ="新增"  
			this.payAmt = ''
			this.remark = ''  
		} 
		 
	  } 
}
 
vm = Vue.createApp(app).mount('#app');
  
</script>

  
</body>
</html>